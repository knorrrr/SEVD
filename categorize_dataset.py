import pickle
import os
import numpy as np
import shutil

def categorize_dataset(base_dir, output_suffix="_11_towns_each_12000_ticks_20251230_201113"):
    info_files = ["train_info.pkl", "val_info.pkl", "test_info.pkl"]
    
    # Thresholds
    SPEED_THRESHOLD = 0.01
    YAW_RATE_THRESHOLD = 0.2
    
    # Output directories
    out_dirs = {
        "stopped": os.path.join(os.path.dirname(base_dir), f"stopped{output_suffix}"),
        "straight": os.path.join(os.path.dirname(base_dir), f"straight{output_suffix}"),
        "curve": os.path.join(os.path.dirname(base_dir), f"curve{output_suffix}")
    }
    
    for name, path in out_dirs.items():
        if not os.path.exists(path):
            os.makedirs(path)
            print(f"Created directory: {path}")
            
    # Process each info file
    for info_file in info_files:
        src_path = os.path.join(base_dir, info_file)
        if not os.path.exists(src_path):
            print(f"Skipping {info_file} (not found)")
            continue
            
        print(f"Processing {info_file}...")
        with open(src_path, 'rb') as f:
            data = pickle.load(f)
            
        categorized_data = {
            "stopped": [],
            "straight": [],
            "curve": []
        }
        
        for item in data:
            t = item['translation']
            r = item['rotation']
            
            speed = np.linalg.norm(t)
            yaw_rate = abs(r[1]) # Abs value for threshold check
            
            # Simple angle wrap-around check if needed, but for frame-to-frame diffs 
            # in this dataset (generated by preprocess_gnss or similar), 
            # the rotation is likely already a small difference.
            # If it were absolute heading, we'd need diff logic, but 'rotation' here 
            # is derived as a delta in the dataset (or verified to be so).
            # Based on previous inspection, r is small values, so it's a delta.
            
            is_moving = speed >= SPEED_THRESHOLD
            
            if not is_moving:
                categorized_data["stopped"].append(item)
            else:
                if yaw_rate < YAW_RATE_THRESHOLD:
                    categorized_data["straight"].append(item)
                else:
                    categorized_data["curve"].append(item)
        
        # Save to respective directories
        for category, items in categorized_data.items():
            dest_path = os.path.join(out_dirs[category], info_file)
            with open(dest_path, 'wb') as f:
                pickle.dump(items, f)
            print(f"  Saved {len(items)} items to {category}/{info_file}")

if __name__ == "__main__":
    base_dir = "/media/ssd/SEVD/carla/out/11_towns_each_12000_ticks_20251230_201113"
    categorize_dataset(base_dir)
